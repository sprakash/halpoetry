<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="css/base.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="shortcut icon" type="image/x-icon" href="https://images.squarespace-cdn.com/content/v1/5e0a34dda233092a4bcdb62f/1578251769701-21NUJB855AA5EQPXPL1U/ke17ZwdGBToddI8pDm48kIqYQBNNprSYxhcypmJOB3tZw-zPPgdn4jUwVcJE1ZvWQUxwkmyExglNqGp0IvTJZUJFbgE-7XRK3dMEBRBhUpx7py1hkY9D8kyy_rCbqTOqmLWwvityEzlBjAV-5jO2XJ5hIGGQLjB1zseI90eovdQ/favicon.ico?format=100w">
	<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.6.0/dist/ffmpeg.min.js"></script>
	<script src="js/RecordRTC.min.js"></script>
	<title>Real Hal's poetry</title>
</head>
<body>
	<main>
		<nav>
			<span class="logo"><img src="assets/colorlogo.png" /></span>
		</nav>
		<section id="content">
				<audio id="myLiveAudio" class="video-js vjs-default-skin"></audio>
				<section id="poem-area">
					<ul class="poem-titles"><!--json populates --></ul>
				</section>
				<section id="poem-action">
					<h1>&larr; Pick one of Hal's poems to read.</h1>
						<div id="poemNow">
							<div class="playArea">
								<section id="poemReadStop">
										<button id="btn-read-poem-only">Read Poem</button>
										<button id="btn-start-recording">Record Poem</button>
										<button id="btn-stop-recording">Stop Recording</button>
										<button id="btn-save-recording">Save Recording</button>

										<div id="message"></div>
								</section>
							</div>
							<section id="poemVisual">
								<section class="poemDbCount">
									<canvas id="gauge"></canvas>
									<div id="gimmeDecibels"></div>
								</section>
								<div id="waveform">
								</div>
								<section class="controls">
									<section>
											<!-- <button id="btn-start-recording">Start Recording</button>
							                <button id="btn-pause-recording" style="display: none; font-size: 15px;">Pause</button>
							                <button id="btn-stop-recording" disabled>Stop Recording</button> -->
							                <div class="recordSection">
								                <div id="recordArea">
								                	<div id="recordIcon"><i class="fa fa-circle text-danger Blink"></i></div>
								                </div>
								                <video controls autoplay playsinline></video>
								            </div>
									</section>


								</section>
							</section>
							
						</div>
				</section>

				<section class="poems">
					<!--json populates -->
				</section>

				<div style="margin-top: 10px;" id="recording-player"></div>

		</section>
	</main>

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/wavesurfer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.2.6/gsap.min.js"></script>
<script src="js/wavesurfer.js"></script>
<script src="js/gauge.min.js"></script>

 <script type="text/javascript">

 	/** BASIC app utility functions
	*/
	 	const $el = document.querySelector('#poem-action h1');
	 	const $playAnim = document.querySelector('.playArea');
	 	const $controls = document.querySelector('.controls');

		const duration = 2.3;
		const from = { opacity: 0, ease: Linear.ease };
		const to = { opacity: 1 };

		var video= document.querySelector('video');


		function fadeInInstruction() {
		   TweenLite.fromTo($el, duration, from, to);
		}

		function fadeOutInstruction() {
			TweenLite.fromTo($el, 1.3, {opacity: 0}, {opacity: 0});
		}

		function fadeInFullPoem() {
			TweenLite.fromTo($playAnim, 5 , from, to);
		}

		function fadeUpInstruction() {
			new TweenMax($el, 2, { y: 200 });
			new TweenMax($el, 2, { y: 0, top: 50, delay: 2.3 });
		}

		function fadeInControls() {
			TweenLite.fromTo($controls, 2.3, from, to);
		}

	/********************************************************************/

	 /**JSON treatment*/

	 /**
	 	TITLES
	 	for ul : poem-titles class append :
	 	each li is id from json for div in li.
	 	title is the div text. 


	 	FULL TEXT 
		for section : poems append : 
		id from json file id with class 'poem'
		idFull with class poem.
		h2 with Full name.
		div with class poemText. 
		divs with each \n\n
							-
							
	 	*/

		 	$.getJSON( "assets/json/poems.json", function( data ) {

				 
				 $.each( data.Poems, function( key, val ) {

				 	var poemlines = val.text.replace(/\n/g, "<br />");
					
					$('.poem-titles').append("<li><a class='poemEach' id="+val.id+" href='javascript:void(0);'>"+val.title+"</a></li>");
					$('.poems').append("<div id="+val.id+"Full class='poem'><h2>"+val.title+"</h2><div class='poemTxt'>"+poemlines+"</div>");
				  });

				  $('.poemEach').on('click touchend', eachpoemclick);
				});
		 		

		/**END JSON Poem readings*/

		/********************************************************************/

		/** BEGIN main event listeners*/

			$(document).ready(function(){
				fadeInInstruction();
				fadeUpInstruction();
			});

				//click on a poem title. 
				function eachpoemclick() {

					$('h1').hide();
					$('.poemFullTitle').remove();
					$('.poemFullContent').remove();

					var poemTitle = $(this).text();
					console.log($(this).text() + "clicked title");

					//fadeout 'pick one of ...'
					fadeOutInstruction();

					var foundPoemTEXT = "#"+this.id+"Full";

					console.log($(foundPoemTEXT+" > .poemTxt").html());

					$('.playArea').prepend("<div class='poemFullTitle'></div><div class='poemFullContent' id='style-4'></div>");
					$('.poemFullContent').html($(foundPoemTEXT+" > .poemTxt").html());
					$('.poemFullTitle').html(poemTitle);
					
					fadeInFullPoem();
					fadeInControls();

					document.querySelector('#btn-read-poem-only').style.visibility = "visible";

				}



		/**END main event listeners*/

		/********************************************************************/

		/** BEGIN wavesurfer 
		*/

		var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
		var wavesurfer, context, processor, mediaStreamSource, analyser, aCtx, lyser, micro, gauge;

		var dial = document.querySelector('.dial .inner');
		var gauge = document.querySelector('.gauge .value');

		 var constraints = {
	         audio: true,
	         video: false
	    }

		function makeWaves() {

			document.getElementById('waveform').innerHTML = '';

				/** BEGIN Waveform */
					          // if (isSafari) {
					               
					                var AudioContext =
					                    window.AudioContext || window.webkitAudioContext;
					                context = new AudioContext();
					                processor = context.createScriptProcessor(1024, 1, 1);
					          //  }

					          	 analyser = context.createAnalyser();
 								 analyser.smoothingTimeConstant = 0.3;
 								 analyser.fftSize = 1024;
					            
					            // if (wavesurfer === undefined) {

					            	 var colors = ['#4aa3ab', '#c3c746', '#de3a57', 'deepskyblue', '#ef0a7f', 'silver', 'seagreen', 'white', 'aliceblue'];
									 var freq = [1, 0];

									  // Grab a random color from the array.
				      				 
				      				 var waveColorPick = colors[Math.floor(Math.random() * colors.length)];
				      				 var waveFreq = freq[Math.floor(Math.random()* freq.length)];
				      				 var ctx = document.createElement('canvas').getContext('2d');
				      				 var linGrad = ctx.createLinearGradient(0, 200, 500, 300);

				    linGrad.addColorStop(freq[Math.floor(Math.random()* freq.length)], colors[Math.floor(Math.random() * colors.length)]);
				    linGrad.addColorStop(freq[Math.floor(Math.random()* freq.length)], colors[Math.floor(Math.random() * colors.length)]);
				    linGrad.addColorStop(freq[Math.floor(Math.random()* freq.length)], colors[Math.floor(Math.random() * colors.length)]);
				    linGrad.addColorStop(freq[Math.floor(Math.random()* freq.length)], colors[Math.floor(Math.random() * colors.length)]);
					linGrad.addColorStop(freq[Math.floor(Math.random()* freq.length)], colors[Math.floor(Math.random() * colors.length)]);
								 
									 wavesurfer = WaveSurfer.create({
									  container     : '#waveform',
									  interact      : false,
									  cursorWidth   : 0,
									  waveColor : linGrad,
					    			  progressColor : 'purple',
					    			  minPxPerSec : 0,
					    			  barWidth : 8,
					    			  hideScrollbar	: true,
					    			  audioContext : context || null,
					                  audioScriptProcessor : processor || null,
									  plugins: [
									    WaveSurfer.microphone.create()
									  ]
									});


									wavesurfer.on('ready', function (){
										console.log("calculate dB");
									});

					            	wavesurfer.microphone.on('deviceReady', function(stream) {
								    	console.log('Device ready!', stream);

								    	aCtx = new AudioContext();
								        lyser = aCtx.createAnalyser();
								        lyser.minDecibels = -90;
										lyser.maxDecibels = -10;

								        micro = aCtx.createMediaStreamSource(stream);
										micro.connect(lyser);


								     //    setInterval(function(){
									    //     FFTData = new Float32Array(lyser.frequencyBinCount);
									    //     lyser.getFloatFrequencyData(FFTData);
									    //     console.log(FFTData[0]);
									    // },10);

									    setInterval(function() { 
										    var array =  new Uint8Array(lyser.frequencyBinCount);
	        								lyser.getByteFrequencyData(array);
	        								var averageVolume = (getAverageVolume(array) < 1 ? 0 : Math.round(getAverageVolume(array)));
	         								console.log('Average volume in this chunk was: ' + averageVolume); 
	         								updateMeter(averageVolume);
	         								updateGaugeVal(averageVolume);
         								}, 25);
								  

									});
								
									wavesurfer.microphone.on('deviceError', function(code) {
								    	console.log('Device error: ' + code);
									});

									wavesurfer.microphone.start();
									$('#waveform').removeClass();
									$('#waveform').addClass('borderism');
									

								// } else {
								// 	wavesurfer.microphone.start();
								// }
							
		}

		function chillWaves() {
			wavesurfer.microphone.stop();
				//$('wave').remove();
				$('#btn-start-recording').css({'visibility':'visible'});
				$('#btn-stop-recording').css({'visibility':'hidden'});
				//$('#waveform').removeClass('borderism');
		}

		function getAverageVolume( array ) {
	        var amplitudeSum = 0;

	        for (var i = 0; i < array.length; i++) {
	            amplitudeSum += array[i];
	        }

	        return amplitudeSum / array.length;
  		}

		function updateMeter(dbVal) {
            var meter = document.getElementById('gimmeDecibels');
            meter.innerHTML = dbVal;
        }

		/**
		END wavesurfer method declarations.
		*/

		/** BEGIN gauge business */

		function makeGauge() {

				gauge = new RadialGauge({
			    renderTo: 'gauge',
			    width: 200,
			    height: 200,
			    value: 0,
			    minValue: 0,
			    startAngle: 90,
			    ticksAngle: 180,
			    valueBox: false,
			    fontNumbersSize: 35,
			    maxValue: 30,
			    majorTicks: [
			        "0",
			        "10",
			        "20",
			        "30"
			    ],
			    minorTicks: 2,
			    strokeTicks: true,
			    highlights: [
			    	{
			          "from": 0,
			          "to": 10,
			          "color": "rgba(243,236,238, 1)"

			        },
			        {
			          "from": 10,
			          "to": 20,
			          "color": "rgba(195,199,70, 1)"
			        },
			        {
			          "from": 20,
			          "to": 30,
			          "color": "rgba(239,10,127, 1)"
			        }
			    ],
			    colorPlate: "#000",
			    colorNeedle: 'rgba(224,103,124,1)',
			    colorNumbers: '#4daab3',
			    borderShadowWidth: 0,
			    borders: false,
			    needleType: "arrow",
			    needleWidth: 5,
			    needleCircleSize: 4,
			    needleCircleOuter: true,
			    needleCircleInner: false,
			    needleStart: 0,
			    animationDuration: 150,
			    animationRule: "linear"
			}).draw();
		}

		function updateGaugeVal(gVal) {
			gauge.value = gVal;
 		}

		/** END gauge business*/


		/**
		BEGIN video capture.
		*/

		function captureCamera(callback) {
			navigator.getWebcam = (navigator.getUserMedia || navigator.webKitGetUserMedia || navigator.moxGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.mediaDevices.getUserMedia);
			navigator.getUserMedia({audio:true, video:true}, function(camera){callback(camera)},function (){console.warn("Error getting audio stream from getUserMedia")} );
		}

		function stopRecordingCallback() {
			video.src = video.srcObject = null;
			video.muted = false; 
			video.volume = 1;
			video.src = URL.createObjectURL(recorder.getBlob());

			recorder.camera.stop();
		}

		function saveRecordingCallback() {
			RecordRTC.invokeSaveAsDialog(recorder.getBlob(), 'yoursession.webm');
			recorder.destroy();
			recorder = null;
		}

		var recorder; // globally accessible

		document.getElementById('btn-read-poem-only').onclick = function() {
			
			document.getElementById('poemReadStop').style.width = '100%';
			document.getElementById('btn-save-recording').style.visibility = 'hidden';
			document.getElementById('btn-start-recording').style.visibility = 'visible';
			document.getElementById('btn-stop-recording').style.visibility = 'hidden';


			captureCamera(function(camera){
				video.muted = true;
				video.volume = 0;
				video.srcObject = camera;
		
			
				document.getElementById('btn-stop-recording').disabled = true;
			});

			makeWaves();
			makeGauge();
		};

		document.getElementById('btn-start-recording').onclick = function() {
			document.getElementById('poemReadStop').style.width = '100%';
			document.getElementById('btn-save-recording').style.visibility = 'hidden';
			document.getElementById('recordIcon').style.visibility = 'visible';

			this.disabled = true; 
			captureCamera(function(camera){
				video.muted = false;
				video.volume = 0;
				video.srcObject = camera;

				recorder = RecordRTC(camera, {
					type: 'video',

					videoMimeType: 'video/webm;codecs=H264'
				});

				recorder.startRecording();
				recorder.camera = camera;

				document.getElementById('btn-stop-recording').disabled = false;
				$("#btn-start-recording").css({'visibility':'hidden'});
				$("#btn-stop-recording").css({'visibility':'visible'});
			});
									
			makeWaves();
		};

		document.getElementById('btn-stop-recording').onclick = function() {

			this.disabled = true;
			document.getElementById('btn-start-recording').disabled = false;
			document.getElementById('btn-start-recording').style.visibility = 'visible';
			document.getElementById('btn-save-recording').style.visibility = 'visible';
			document.getElementById('recordIcon').style.visibility = 'hidden';

			recorder.stopRecording(stopRecordingCallback);
			//chillWaves();
		};

		document.getElementById('btn-save-recording').onclick = function() {
			saveRecordingCallback();
		};

		/**
		END with save recording
		*/




	</script>

           
            

</body>
</html>